<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gurukul Utsav Book Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Ensure Tailwind is loaded before configuration
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof tailwind !== 'undefined') {
                tailwind.config = {
                    theme: {
                        extend: {
                            fontFamily: {
                                inter: ['Inter', 'sans-serif'],
                            },
                            colors: {
                                'dark-bg': '#03040A',
                                'text-color-primary': '#e5e7eb',
                                'text-color-secondary': '#9ca3af',
                                'glass-bg': 'rgba(15, 12, 29, 0.4)',
                                'glass-border': 'rgba(255, 255, 255, 0.1)',
                                'input-bar-bg': 'rgba(10, 8, 20, 0.7)',
                                'form-button-bg': '#007BFF', /* Primary button color */
                                'form-button-hover': '#0056b3',
                                'error-red': '#ef4444', /* Tailwind red-500 */
                                'success-green': '#22c55e', /* Tailwind green-500 */
                                'scroll-thumb-bg': 'rgba(148, 163, 184, 0.3)',
                                'splash-bg': 'rgba(0, 0, 0, 0.6)',
                                'settings-highlight-bg': 'rgba(255, 255, 255, 0.05)',
                                'form-field-bg-dark': 'rgba(0, 0, 0, 0.3)', /* Dark mode input field background */
                                'book-selected-bg': 'rgba(0, 123, 255, 0.15)', /* New: for selected book item */
                                'book-selected-border': '#007BFF', /* New: for selected book item */
                                'bot-message-bg': 'rgba(43, 46, 62, 0.7)', /* New: specifically for bot messages */
                                'summary-card-bg': 'rgba(255, 255, 255, 0.1)', /* Background for summary cards */
                            }
                        },
                    }
                };
            } else {
                console.error("Tailwind CSS not loaded. Cannot apply custom configuration.");
            }
        });
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* ------------------------------ */
        /* CSS Variables for Theming      */
        /* ------------------------------ */
        :root {
            --bg-color: #03040A;
            --text-color-primary: #e5e7eb;
            --text-color-secondary: #9ca3af;
            --glass-bg: rgba(15, 12, 29, 0.4);
            --glass-border: rgba(255, 255, 255, 0.1);
            --form-field-bg: rgba(0, 0, 0, 0.3);
            --form-button-bg: #007BFF;
            --form-button-hover: #0056b3;
            --scroll-thumb-bg: rgba(148, 163, 184, 0.3);
            --splash-bg: rgba(0, 0, 0, 0.6);
            --settings-highlight-bg: rgba(255, 255, 255, 0.05);
            --book-selected-bg: rgba(0, 123, 255, 0.15);
            --book-selected-border: #007BFF;
            --bot-message-bg: rgba(43, 46, 62, 0.7);
            --summary-card-bg: rgba(255, 255, 255, 0.1);

            /* Zoom variables */
            --global-font-size: 16px; /* Base font size for 'rem' calculation */
            --container-max-width: 600px; /* Base max-width for container */
        }

        .light-theme {
            --bg-color: #F0F2F5;
            --text-color-primary: #1f2937;
            --text-color-secondary: #4b5563;
            --glass-bg: rgba(240, 240, 240, 0.9); /* More opaque light tint for light mode */
            --glass-border: rgba(0, 0, 0, 0.1);
            --form-field-bg: rgba(220, 220, 220, 0.9); /* Light grey for inputs in light mode */
            --form-button-bg: #007BFF;
            --form-button-hover: #0069d9;
            --scroll-thumb-bg: rgba(107, 114, 128, 0.4);
            --splash-bg: rgba(255, 255, 255, 0.5);
            --settings-highlight-bg: rgba(0, 0, 0, 0.05);
            --book-selected-bg: rgba(0, 123, 255, 0.2); /* More visible blue tint in light mode */
            --book-selected-border: #007BFF;
            --bot-message-bg: rgba(229, 231, 235, 1); /* Light grey for bot messages */
            --summary-card-bg: rgba(0, 0, 0, 0.05);
        }

        /* ------------------------------ */
        /* Base Styling                   */
        /* ------------------------------ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color-primary);
            transition: background-color 0.5s ease, color 0.5s ease;
            font-size: var(--global-font-size); /* Apply global font size */
            overflow: hidden; /* Prevent scroll on body during splash */
        }

        /* ------------------------------ */
        /* Dynamic Evolving Waves         */
        /* ------------------------------ */
        #dynamic-background {
            position: fixed; inset: 0; z-index: 0; overflow: hidden;
            background-color: var(--bg-color);
            transition: background-color 0.5s ease;
        }
        #dynamic-background .wave {
            position: absolute; border-radius: 50%; filter: blur(120px); opacity: 0.5;
        }

        @keyframes wave-move-1 { 0% { transform: translate(0, 0) rotate(0deg) scale(1.2); } 50% { transform: translate(150px, 100px) rotate(180deg) scale(1.4); } 100% { transform: translate(0, 0) rotate(360deg) scale(1.2); } }
        @keyframes wave-move-2 { 0% { transform: translate(0, 0) rotate(0deg) scale(1); } 50% { transform: translate(-200px, -150px) rotate(180deg) scale(1.2); } 100% { transform: translate(0, 0) rotate(360deg) scale(1); } }
        @keyframes wave-move-3 { 0% { transform: translate(0, 0) rotate(0deg) scale(1.1); } 50% { transform: translate(100px, -150px) rotate(-180deg) scale(1.3); } 100% { transform: translate(0, 0) rotate(-360deg) scale(1.1); } }
        @keyframes change-color-1 { 0%, 100% { background-color: #1a0033; } 33% { background-color: #001f2e; } 66% { background-color: #0d1127; } }
        @keyframes change-color-2 { 0%, 100% { background-color: #001f2e; } 33% { background-color: #0d1127; } 66% { background-color: #2a004d; } }
        @keyframes change-color-3 { 0%, 100% { background-color: #0d1127; } 33% { background-color: #1a0033; } 66% { background-color: #00334d; } }

        .wave-1 { width: 800px; height: 800px; top: -25%; left: -15%; animation: wave-move-1 30s cubic-bezier(0.36, 0.45, 0.63, 0.53) infinite, change-color-1 20s ease-in-out infinite; }
        .wave-2 { width: 900px; height: 900px; bottom: -30%; right: -20%; animation: wave-move-2 25s cubic-bezier(0.36, 0.45, 0.63, 0.53) -10s infinite, change-color-2 20s ease-in-out -5s infinite; }
        .wave-3 { width: 700px; height: 700px; bottom: 5%; left: -10%; animation: wave-move-3 20s cubic-bezier(0.36, 0.45, 0.63, 0.53) -5s infinite, change-color-3 20s ease-in-out -15s infinite; }

        .light-theme #dynamic-background { opacity: 0; }

        /* ------------------------------ */
        /* Splash Screen & Animations     */
        /* ------------------------------ */
        #splash { background-color: var(--splash-bg); transition: background-color 0.5s ease; }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; visibility: hidden; } }
        .animate-fade-out { animation: fadeOut 1.5s ease-in-out forwards; }

        /* Splash Image - Central Logo */
        @keyframes splash-image-pop {
            0% { opacity: 0; transform: scale(0.5); }
            100% { opacity: 1; transform: scale(1); }
        }
        .splash-image-style {
            animation: splash-image-pop 0.8s ease-out forwards;
            animation-delay: 0.2s;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #FFD700; /* Gold border */
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        /* Main Splash Text */
        @keyframes splash-title-fade-in {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .animate-splash-title {
            animation: splash-title-fade-in 1s ease-out forwards;
            animation-delay: 0.8s;
        }

        /* Golden Text (if reused) */
        .golden-text {
            background: linear-gradient(45deg, #FFD700, #FFA500, #FFD700); /* Gold gradient */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% auto;
            animation: shine 3s linear infinite;
        }
        @keyframes shine {
            to { background-position: 200% center; }
        }

        /* ------------------------------ */
        /* Polished Glass Container       */
        /* ------------------------------ */
        .glass-container {
            background: var(--glass-bg);
            backdrop-filter: blur(50px) saturate(180%);
            border: 1px solid var(--glass-border);
            box-shadow: 0 15px 35px rgba(0,0,0,0.3), inset 0 0 0 1.5px rgba(255, 255, 255, 0.05);
            transition: background-color 0.5s ease, border 0.5s ease, max-width 0.3s ease; /* Add max-width transition */
            max-width: var(--container-max-width); /* Controlled by JS zoom */
            max-height: 95vh; /* Limit height of the entire window */
            overflow-y: auto; /* Make the entire glass container scrollable */
        }

        /* Scrollbar styles for the main container */
        .glass-container::-webkit-scrollbar { width: 6px; }
        .glass-container::-webkit-scrollbar-track { background: transparent; }
        .glass-container::-webkit-scrollbar-thumb { background-color: var(--scroll-thumb-bg); border-radius: 3px; }
        .glass-container::-webkit-scrollbar-thumb:hover { background-color: rgba(148, 163, 184, 0.5); }

        /* Form elements styling */
        .input-group label {
            color: var(--text-color-primary);
            font-weight: 500;
        }
        .input-group input {
            background-color: var(--form-field-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-color-primary);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Added subtle shadow */
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            font-size: 1.1em; /* Made font bigger */
            padding: 0.85rem; /* Adjusted padding */
        }
        .input-group input:focus {
            outline: none;
            border-color: var(--form-button-bg);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3), 0 4px 8px rgba(0, 0, 0, 0.2); /* Enhanced focus shadow */
        }

        /* Specific styling for phone input group to use flexbox */
        .phone-input-group {
            display: flex;
            align-items: center; /* Align items to the center for a cohesive look */
            gap: 0.5rem; /* Space between country code and phone number input */
            border: 1px solid var(--glass-border); /* Shared border for the whole group */
            border-radius: 0.5rem; /* Rounded corners for the group */
            background-color: var(--form-field-bg); /* Shared background */
            padding-right: 0.75rem; /* Padding on the right for icon/input */
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Added subtle shadow */
        }

        .phone-input-group:focus-within {
            border-color: var(--form-button-bg);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3), 0 4px 8px rgba(0, 0, 0, 0.2); /* Enhanced focus shadow */
        }

        .phone-input-group .country-code-select {
            border: none; /* Remove individual border */
            background-color: transparent; /* Make background transparent */
            padding: 0.75rem; /* Consistent padding */
            border-right: 1px solid var(--glass-border); /* Separator line */
            border-radius: 0.5rem 0 0 0.5rem; /* Round only left corners */
            -webkit-appearance: none; /* Remove default arrow on Chrome/Safari */
            -moz-appearance: none; /* Remove default arrow on Firefox */
            appearance: none; /* Remove default arrow */
            cursor: pointer;
            outline: none;
            color: var(--text-color-primary);
            height: 100%; /* Make select fill height */
            font-size: 1.1em; /* Made font bigger */
        }

        /* Custom arrow for select dropdown */
        .phone-input-group .country-code-select-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
            height: 100%; /* Ensure wrapper takes full height */
        }
        .phone-input-group .country-code-select-wrapper::after {
            content: '▼'; /* Unicode character for a dropdown arrow */
            position: absolute;
            right: 0.5rem;
            font-size: 0.7em;
            pointer-events: none; /* Ensure clicks pass through to select */
            color: var(--text-color-secondary);
        }

        .phone-input-group input[type="tel"] {
            border: none; /* Remove individual border */
            background-color: transparent; /* Make background transparent */
            flex-grow: 1; /* Allow it to take remaining space */
            padding: 0.75rem; /* Consistent padding */
            outline: none;
            color: var(--text-color-primary);
            height: 100%; /* Make input fill height */
            font-size: 1.1em; /* Made font bigger */
        }
        .phone-input-group .phone-icon {
            color: var(--text-color-secondary);
            margin-left: 0.5rem;
        }


        .book-item {
            background-color: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--text-color-primary);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease; /* Added transform */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); /* Subtle initial shadow */
        }
        /* Light theme specific background for book item */
        .light-theme .book-item {
            background-color: rgba(0, 0, 0, 0.03); /* Darker tint for light mode */
        }

        /* Added hover effect for book item */
        .book-item:hover {
            transform: translateY(-3px); /* Lift effect */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); /* Enhanced shadow on hover */
        }

        /* Style for selected book item */
        .book-item.selected {
            background-color: var(--book-selected-bg);
            border-color: var(--book-selected-border);
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.4);
        }

        /* Quantity controls */
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .quantity-control button {
            background-color: var(--form-button-bg);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            box-shadow: none; /* Remove default button shadow */
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .quantity-control button:hover {
            background-color: var(--form-button-hover);
            transform: scale(1.1);
        }
        .quantity-control button:active {
            transform: scale(0.9);
        }
        .quantity-control input[type="text"] {
            width: 48px;
            padding: 0.25rem 0.5rem;
            text-align: center;
            background-color: var(--form-field-bg);
            border: 1px solid var(--glass-border);
            border-radius: 0.5rem;
            color: var(--text-color-primary);
            font-size: 1em;
            pointer-events: none; /* Make it non-editable by direct typing */
        }


        #total-price {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text-color-primary);
            text-align: right;
            margin-top: 1.5rem;
        }

        button {
            background-color: var(--form-button-bg);
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 9999px; /* pill shape */
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        button:hover {
            background-color: var(--form-button-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Theme and Zoom buttons */
        .settings-button {
            background-color: var(--settings-highlight-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-color-primary);
            padding: 0.5rem 0.75rem;
            border-radius: 9999px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .settings-button:hover {
            background-color: var(--glass-border);
        }

        /* Message box for alerts */
        #message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #message-box.show {
            opacity: 1;
            visibility: visible;
        }
        #message-box .icon {
            font-size: 1.5em;
        }
        #message-box.success { background-color: #22c55e; }
        #message-box.error { background-color: #ef4444; }

        /* Bot Message Styling (similar to previous registration form) */
        .bot-message {
            background: var(--bot-message-bg);
            color: var(--text-color-primary);
            align-self: flex-start; /* Align to the left */
            border-radius: 1.5rem; /* Large radius for a bubble effect */
            border-bottom-left-radius: 0.5rem; /* Smoother corner on one side */
            display: flex; /* Make it a flex container */
            align-items: flex-start; /* Align icon and text at the top */
            padding: 1rem 1.5rem; /* Adjust padding for icon */
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.05);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease-in-out;
            max-width: 90%; /* Limit width */
            margin-bottom: 1.5rem; /* Space below message */
        }
        .bot-message.active {
            opacity: 1;
            transform: translateY(0);
        }
        .bot-message .bot-avatar {
            width: 120px; /* w-10 */
            height: 120px; /* h-10 */
            border-radius: 50%; /* rounded-full */
            object-fit: cover;
            margin-right: 0.75rem; /* mr-3 */
            flex-shrink: 0; /* Prevent avatar from shrinking */
            border: 2px solid var(--form-button-bg); /* Small border for bot avatar */
        }
        /* New: Styling for the text content within bot message */
        .bot-message .bot-text-content {
            flex-grow: 1; /* Allow text content to take remaining space */
            font-size: 1.15em; /* Make text bigger */
            font-weight: 600; /* Make text bolder */
            line-height: 1.5; /* Improve readability with more line spacing */
        }
        .bot-message .bot-text-content strong {
            color: white; /* Ensure strong text is very clear */
        }
        .light-theme .bot-message .bot-text-content strong {
            color: var(--text-color-primary); /* Darker text in light mode */
        }


        /* Purchase Summary Modal Styles */
        .purchase-summary-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 900; /* Below message box, above main content */
            opacity: 0;
            transition: opacity 0.3s ease;
            visibility: hidden;
        }
        .purchase-summary-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .purchase-summary-modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border-radius: 1.5rem;
            padding: 2.5rem;
            color: var(--text-color-primary);
            width: 90%;
            max-width: 500px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            overflow-y: auto; /* Allow content to scroll if too long */
            max-height: 85vh; /* Max height for modal content */
        }
        .purchase-summary-modal-overlay.show .purchase-summary-modal-content {
            transform: scale(1);
        }
        .purchase-summary-modal-content h2 {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-align: center;
            color: white;
            text-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .light-theme .purchase-summary-modal-content h2 {
            color: var(--text-color-primary); /* Darker text in light mode */
            text-shadow: none;
        }
        .purchase-summary-modal-content .summary-section-item {
            background-color: var(--summary-card-bg);
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
            line-height: 1.6;
        }
        .purchase-summary-modal-content .summary-section-item strong {
            color: var(--text-color-secondary);
            min-width: 90px;
            display: inline-block;
        }
        .purchase-summary-modal-content .summary-book-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
            font-size: 0.95em;
        }
        .purchase-summary-modal-content .summary-book-item:last-child {
            border-bottom: none;
        }
        .purchase-summary-modal-content .summary-total {
            font-size: 1.75em;
            font-weight: 700;
            text-align: right;
            margin-top: 1.5rem;
            color: white;
        }
        .light-theme .purchase-summary-modal-content .summary-total {
            color: var(--text-color-primary); /* Darker text in light mode */
        }
        .purchase-summary-modal-actions {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
        }
        .purchase-summary-modal-actions button {
            width: 100%;
            padding: 0.9rem 1.5rem;
            font-size: 1.1em;
        }
        .purchase-summary-modal-actions .cancel-button {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-color-primary);
        }
        .light-theme .purchase-summary-modal-actions .cancel-button {
            background-color: rgba(0, 0, 0, 0.1); /* Darker tint for light mode */
        }
        .purchase-summary-modal-actions .cancel-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .light-theme .purchase-summary-modal-actions .cancel-button:hover {
            background-color: rgba(0, 0, 0, 0.2); /* Darker tint on hover for light mode */
        }

        /* NEW: Final Confirmation Action Bar (Bot Message Style) */
        #final-confirmation-action-bar {
            position: sticky; /* Make it sticky to the bottom of its scrollable parent */
            bottom: 0;
            margin-top: auto; /* Pushes it to the bottom in a flex-col container */

            padding: 1rem 1.5rem; /* Match bot message padding */
            width: 100%;
            background: var(--bot-message-bg); /* Use bot message background */
            backdrop-filter: blur(15px); /* Stronger blur */
            border: 1px solid rgba(255, 255, 255, 0.05); /* Match bot message border */
            z-index: 30; /* Ensure it's above normal content but below modals */

            display: flex; /* Use flex for layout with avatar */
            align-items: flex-start; /* Align avatar and content to the top */
            gap: 0.75rem; /* Space between avatar and content */

            border-radius: 1.5rem; /* Large radius for a bubble effect */
            border-bottom-left-radius: 0.5rem; /* Smoother corner on bot's side */
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25); /* Match bot message shadow */

            opacity: 0; /* Hidden by default */
            visibility: hidden;
            transform: translateY(100%); /* Slide in from bottom */
            transition: opacity 0.4s ease-out, transform 0.4s ease-out, visibility 0.4s;
        }

        #final-confirmation-action-bar.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        #final-confirmation-action-bar .bot-avatar {
            width: 120px; /* Match bot message avatar size */
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0; /* Prevent avatar from shrinking */
            border: 2px solid var(--form-button-bg); /* Match bot avatar border */
        }

        #final-confirmation-action-bar .content-wrapper {
            flex-grow: 1; /* Allow content to take remaining space */
            display: flex; /* This is the key change to ensure internal stacking */
            flex-direction: column; /* Ensure text and buttons stack vertically */
            align-items: flex-start; /* Align items to the left within the content wrapper */
            min-width: 0; /* Allow content-wrapper to shrink if needed */
        }

        #final-confirmation-action-bar #final-confirmation-text {
            font-size: 1.15em; /* Match bot message text size */
            font-weight: 600; /* Match bot message text weight */
            color: var(--text-color-primary);
            text-align: left; /* Text alignment within its own wrapper */
            margin-bottom: 1rem; /* Space between text and buttons */
            line-height: 1.5; /* Match bot message line height */
            word-break: break-word; /* Ensure long text breaks */
        }

        #final-confirmation-action-bar .button-group {
            display: flex;
            gap: 1rem;
            width: 100%; /* Make buttons take full width on small screens */
            flex-wrap: wrap; /* Allow buttons to wrap to next line if needed */
        }
        #final-confirmation-action-bar .button-group button {
            flex: 1; /* Make buttons share space equally */
            padding: 0.9rem 1.5rem; /* Larger buttons */
            font-size: 1.1em;
            min-width: 120px; /* Ensure buttons don't get too small */
        }

        @media (min-width: 640px) { /* sm breakpoint */
            #final-confirmation-action-bar {
                padding: 1.5rem 2rem; /* Adjusted padding for larger screens */
                /* Keep bot message bubble shape consistent across sizes */
                border-radius: 1.5rem;
                border-bottom-left-radius: 0.5rem;
            }
            /* Remove explicit flex-direction changes for content-wrapper here, it's always column */
            #final-confirmation-action-bar .content-wrapper {
                /* No change to flex-direction from base */
                align-items: flex-start; /* Ensure items stay left-aligned */
            }
            #final-confirmation-action-bar #final-confirmation-text {
                /* No change here, text stays above buttons */
            }
            #final-confirmation-action-bar .button-group {
                /* No change here, buttons stay below text */
            }
        }
        /* Fix for light mode text color on final confirmation bar */
        .light-theme #final-confirmation-action-bar #final-confirmation-text {
            color: var(--text-color-primary);
        }

    </style>
</head>
<body class="text-slate-200">

    <div id="dynamic-background">
        <div class="wave wave-1"></div>
        <div class="wave wave-2"></div>
        <div class="wave wave-3"></div>
    </div>

    <!-- Splash Screen -->
    <div id="splash" class="fixed inset-0 z-50 flex flex-col items-center justify-center backdrop-blur-sm bg-[var(--splash-bg)]">
        <img id="splash-image" src="https://placehold.co/150x150/FFD700/000000?text=Book" alt="Book Shop Logo" class="w-32 h-32 md:w-40 md:h-40 object-contain mb-8 shadow-2xl rounded-full hidden">

        <h1 id="splash-main-title" class="text-white text-3xl sm:text-4xl md:text-5xl font-bold tracking-wide text-center px-4 mb-8 opacity-0">
            Rajaram Gurukul Utsav Book Shop
        </h1>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="flex items-center gap-2 rounded-lg py-3 px-5 text-white">
        <i id="message-icon" class="fas"></i>
        <span id="message-text"></span>
    </div>

    <!-- Purchase Summary Modal Overlay -->
    <div id="purchase-summary-modal-overlay" class="purchase-summary-modal-overlay">
        <div class="purchase-summary-modal-content">
            <h2><i class="fas fa-shopping-cart mr-2"></i>Final Confirmation: Review Your Booking!</h2>
            <p class="mb-4 text-center text-sm text-yellow-300">
                Please carefully review your details below. Make sure your name, phone number, and order are correct.
            </p>
            <div id="summary-details">
                <!-- Dynamic content will be loaded here -->
            </div>
            <div class="purchase-summary-modal-actions">
                <button onclick="confirmPurchasePrompt()"><i class="fas fa-check-circle mr-2"></i>Confirm & Pay</button>
                <button class="cancel-button" onclick="editPurchase()"><i class="fas fa-edit mr-2"></i>Edit Cart</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="relative z-10 flex items-center justify-center min-h-screen p-2 md:p-4 overflow-auto hidden opacity-0 transition-opacity duration-500">
        <div class="glass-container flex flex-col w-full rounded-3xl p-6 sm:p-8">

            <div class="flex items-center justify-between p-4 border-b border-white/10 flex-wrap gap-2 mb-4">
                <h1 class="text-xl md:text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300 tracking-wide">
                    RajaramGurukul Shop
                </h1>
                <div class="flex gap-2">
                    <button id="zoom-out-btn" class="settings-button" aria-label="Zoom Out">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button id="zoom-in-btn" class="settings-button" aria-label="Zoom In">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button id="theme-toggle" class="settings-button" aria-label="Toggle theme">
                        <i class="fas fa-sun text-yellow-300" id="sun-icon"></i>
                        <i class="fas fa-moon text-blue-300 hidden" id="moon-icon"></i>
                        <span id="theme-text" class="hidden sm:inline">Dark Mode</span>
                    </button>
                    <button  aria-label="Home Page">
                       <a href="/" class="settings-button" aria-label="Home Page">
                            Home Page
                       </a>
                    </button>
                </div>
            </div>

            <!-- Bot Message Container -->
            <div id="bot-message-container" class="flex flex-col items-start px-2 py-4">
                <!-- Bot messages will be appended here -->
            </div>

            <div class="container bg-transparent shadow-none p-0 max-w-full">
                <h2 class="text-2xl font-bold text-white mb-6"><i class="fas fa-book-open mr-2"></i>Buy Your Books</h2>

                <div class="input-group mb-4">
                    <label for="first-name" class="block mb-2 text-sm font-medium">First Name</label>
                    <input type="text" id="first-name" class="w-full p-3 rounded-lg text-sm" required>
                </div>
                <div class="input-group mb-6">
                    <label for="last-name" class="block mb-2 text-sm font-medium">Last Name</label>
                    <input type="text" id="last-name" class="w-full p-3 rounded-lg text-sm" required>
                </div>

                <div class="input-group mb-6">
                    <label class="block mb-2 text-sm font-medium">Phone Number</label>
                    <div class="phone-input-group">
                        <div class="country-code-select-wrapper">
                            <label for="phone-country-code" class="sr-only">Country Code</label>
                            <select id="phone-country-code" class="country-code-select">
                                <option value="+91">IN (+91)</option>
                                <option value="+1">US (+1)</option>
                                <option value="+44">UK (+44)</option>
                                <option value="+61">AU (+61)</option>
                                <option value="+81">JP (+81)</option>
                                <option value="+86">CN (+86)</option>
                                <option value="+49">DE (+49)</option>
                                <option value="+33">FR (+33)</option>
                                <option value="+39">IT (+39)</option>        <!-- Italy -->
                                <option value="+7">RU (+7)</option>          <!-- Russia -->
                                <option value="+34">ES (+34)</option>        <!-- Spain -->
                                <option value="+82">KR (+82)</option>        <!-- South Korea -->
                                <option value="+966">SA (+966)</option>      <!-- Saudi Arabia -->
                                <option value="+971">AE (+971)</option>      <!-- United Arab Emirates -->
                                <option value="+92">PK (+92)</option>        <!-- Pakistan -->
                                <option value="+880">BD (+880)</option>      <!-- Bangladesh -->
                                <option value="+62">ID (+62)</option>        <!-- Indonesia -->
                                <option value="+60">MY (+60)</option>        <!-- Malaysia -->
                                <option value="+63">PH (+63)</option>        <!-- Philippines -->
                                <option value="+234">NG (+234)</option>      <!-- Nigeria -->
                                <option value="+27">ZA (+27)</option>        <!-- South Africa -->
                                <option value="+55">BR (+55)</option>        <!-- Brazil -->
                                <option value="+52">MX (+52)</option>        <!-- Mexico -->
                                <option value="+20">EG (+20)</option>        <!-- Egypt -->
                                <option value="+31">NL (+31)</option>        <!-- Netherlands -->
                                <option value="+46">SE (+46)</option>        <!-- Sweden -->
                                <option value="+47">NO (+47)</option>        <!-- Norway -->
                                <option value="+90">TR (+90)</option>        <!-- Turkey -->
                                <!-- Add more country codes as needed -->
                            </select>
                        </div>
                        <label for="phone" class="sr-only">Phone Number</label>
                        <input type="tel" id="phone" class="flex-grow p-3 text-sm" required>
                        <i class="fas fa-phone-alt phone-icon"></i>
                    </div>
                </div>

                <h3 class="text-xl font-semibold text-white mb-4"><i class="fas fa-list-alt mr-2"></i>Choose Books:</h3>
                <div id="book-list" class="space-y-3"></div>

                <div id="total-price" class="text-xl font-bold text-right mt-8">Total: ₹0</div>

                <button onclick="displayPurchaseSummary()" class="mt-8 w-full">
                    <i class="fas fa-paper-plane mr-2"></i>Submit Purchase
                </button>
            </div>

            <!-- NEW: Final Confirmation Action Bar (Bot Message Style) -->
            <div id="final-confirmation-action-bar"
                 class="hidden mt-auto sticky bottom-0 w-full z-30
                        flex justify-center items-start rounded-bl-xl rounded-br-3xl">
                <img src="static/self-me.png" alt="Bot Avatar" class="bot-avatar">
                <div class="content-wrapper">
                    <p id="final-confirmation-text"></p>
                    <div class="button-group">
                        <button id="final-confirm-yes" class="form-button flex-1"><i class="fas fa-check"></i> Yes, Confirm!</button>
                        <button id="final-confirm-no" class="form-button bg-gray-500 hover:bg-gray-600 flex-1"><i class="fas fa-times"></i> No, Edit!</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const splashScreen = document.getElementById('splash');
        const splashImage = document.getElementById('splash-image');
        const splashMainTitle = document.getElementById('splash-main-title');
        const mainContent = document.getElementById('main-content');
        const themeToggle = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        const themeText = document.getElementById('theme-text');
        const zoomInBtn = document.getElementById('zoom-in-btn');
        const zoomOutBtn = document.getElementById('zoom-out-btn');
        const messageBox = document.getElementById('message-box');
        const messageIcon = document.getElementById('message-icon');
        const messageText = document.getElementById('message-text');

        const bookListDiv = document.getElementById('book-list');
        const totalPriceDisplay = document.getElementById('total-price');
        const botMessageContainer = document.getElementById('bot-message-container');

        const purchaseSummaryModalOverlay = document.getElementById('purchase-summary-modal-overlay');
        const summaryDetailsDiv = document.getElementById('summary-details');

        // New DOM elements for the final confirmation action bar
        const finalConfirmationActionBar = document.getElementById('final-confirmation-action-bar');
        const finalConfirmationText = document.getElementById('final-confirmation-text');
        const finalConfirmYesBtn = document.getElementById('final-confirm-yes');
        const finalConfirmNoBtn = document.getElementById('final-confirm-no');


        // Bot Avatar Image (Placeholder - User will replace this)
        const botAvatarSrc = "static/self-me.png"; // Placeholder for bot avatar

        // --- Data (No Fetch) ---
        const books = [
            { id: 1, name: "Saptashati", price: 50 },
            { id: 2, name: "Sitamai Dainandini Upasana", price: 25 },
            { id: 3, name: "Gurudev Smaranika", price: 60 },
            { id: 4, name: "Samagra Charitra", price: 250 },
            { id: 5, name: "Ramayan", price: 100 },
            { id: 6, name: "Dainandin Upasana", price: 30 },
            { id: 7, name: "Turning Point", price: 300 },
            { id: 8, name: "Smrutigandha", price: 180 },
            { id: 9, name: "Priya Mauli", price: 350 },
            { id: 10, name: "Bhajanavali", price: 100 },
            { id: 11, name: "Bodhapushpe", price: 70 },
            { id: 12, name: "Swapnabodh Sagar", price: 250 },
            { id: 13, name: "Swapna Sarita", price: 200 },
            { id: 14, name: "Takta", price: 5 },
            { id: 15, name: "Photo (Small)", price: 20 },
            { id: 16, name: "Amrutvel", price: 35 },
            { id: 17, name: "Dinadarshika", price: 190 },
            { id: 18, name: "New Geeta", price: 800 },
            { id: 19, name : "Priya Bala" , price : 80}
        ];

        // --- Theme Logic ---
        let isLightMode = false; // Default to dark mode

        function toggleTheme() {
            isLightMode = !isLightMode;
            if (isLightMode) {
                document.body.classList.add('light-theme');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
                themeText.textContent = 'Light Mode';
            } else {
                document.body.classList.remove('light-theme');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
                themeText.textContent = 'Dark Mode';
            }
            localStorage.setItem('theme', isLightMode ? 'light' : 'dark'); // Save preference
        }

        // Apply saved theme on load
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            isLightMode = false; // Will be true after toggleTheme()
            toggleTheme();
        } else {
            isLightMode = true; // Will be false after toggleTheme()
            toggleTheme(); // Set to dark mode initially if no preference or 'dark'
        }

        themeToggle.addEventListener('click', toggleTheme);

        // --- Zoom Logic ---
        // Simulating 3 clicks of zoom-in button (1.0 * 1.25 * 1.25 * 1.25 = 1.953125)
        let currentZoomLevel = 1.95; // Initial zoom level set to simulate 3 zoom-in clicks
        const zoomFactor = 1.25; // 25% increase/decrease
        const baseFontSize = 16; // px, corresponds to 1rem
        const baseContainerMaxWidth = 600; // px

        function updateZoom() {
            // Set global font size for root rem calculation
            document.documentElement.style.setProperty('--global-font-size', `${baseFontSize * currentZoomLevel}px`);
            // Adjust the max-width of the glass container for chat size
            document.documentElement.style.setProperty('--container-max-width', `${baseContainerMaxWidth * currentZoomLevel}px`);
        }

        zoomInBtn.addEventListener('click', () => {
            currentZoomLevel = Math.min(1.95, currentZoomLevel * zoomFactor); // Max zoom level
            updateZoom();
        });

        zoomOutBtn.addEventListener('click', () => {
            currentZoomLevel = Math.max(0.64, currentZoomLevel / zoomFactor); // Min zoom level
            updateZoom();
        });

        // Initialize zoom level on load
        updateZoom();

        // --- Message Box Display ---
        function showMessage(message, type = 'info') {
            messageText.textContent = message;
            messageBox.className = `message-box show ${type}`; // Reset classes and add type

            // Set icon based on type
            messageIcon.className = 'fas icon';
            if (type === 'success') {
                messageIcon.classList.add('fa-check-circle');
            } else if (type === 'error') {
                messageIcon.classList.add('fa-times-circle');
            } else {
                messageIcon.classList.add('fa-info-circle');
            }

            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000); // Hide after 3 seconds
        }

        /**
         * Adds a bot message element to the bot message container.
         * @param {string} messageHtml - HTML string for the message content.
         * @returns {Promise<void>} A promise that resolves when the message animation is complete.
         */
        function addBotMessage(messageHtml) {
            return new Promise(resolve => {
                const messageElement = document.createElement('div');
                messageElement.className = 'bot-message';
                messageElement.innerHTML = `
                    <img src="${botAvatarSrc}" alt="Bot Avatar" class="bot-avatar">
                    <div class="bot-text-content">
                        ${messageHtml}
                    </div>
                `;
                botMessageContainer.appendChild(messageElement);

                // Trigger animation
                setTimeout(() => {
                    messageElement.classList.add('active');
                    // Scroll to bottom of the glass container if it's scrollable
                    const glassContainer = document.querySelector('.glass-container');
                    if (glassContainer) {
                        glassContainer.scrollTop = glassContainer.scrollHeight;
                    }
                    // Resolve the promise when the animation ends
                    messageElement.addEventListener('transitionend', () => resolve(), { once: true });
                }, 50);
            });
        }


        // --- Splash Screen Animation and Initial Load Logic ---
        window.onload = () => {
            // Animate logo
            splashImage.classList.remove('hidden');
            splashImage.classList.add('splash-image-style');

            // Animate main title
            setTimeout(() => {
                splashMainTitle.classList.add('animate-splash-title');
                splashMainTitle.classList.remove('opacity-0');
            }, 800);

            // Fade out splash screen after all animations
            setTimeout(() => {
                splashScreen.classList.add('animate-fade-out');
                splashScreen.addEventListener('animationend', async () => { // Made async to await bot message
                    splashScreen.remove();
                    mainContent.classList.remove('hidden');
                    // Small delay to ensure display is set before opacity transition
                    setTimeout(async () => { // Nested setTimeout for sequential animation
                        mainContent.classList.remove('opacity-0');
                        document.body.style.overflow = 'auto'; // Re-enable body scroll

                        // Show initial bot message and wait for its animation to complete
                        await addBotMessage(`
                            Hello! I'm Aditya Paranjape.
                            Let's guide you through this book shop.
                            <br><br>
                            <strong>How to use this shop:</strong>
                            <ul class="list-disc list-inside mt-2 text-sm">
                                <li>Enter your first name, last name, and phone number in the fields above.</li>
                                <li>Use the <strong class="text-white">+</strong> and <strong class="text-white">-</strong> buttons next to each book to adjust the quantity.</li>
                                <li>The selected books will highlight in blue.</li>
                                <li>The <strong class="text-white">Total</strong> price will update automatically.</li>
                                <li>Click <strong class="text-white">'Submit Purchase'</strong> when you're ready!</li>
                            </ul>
                            Happy reading!
                        `);

                        // Only then render the books
                        renderBooks();
                    }, 50);
                }, { once: true });
            }, 2500); // Total splash animation duration approx 2.5 seconds
        };

        // --- Book List Rendering and Interaction ---
        function renderBooks() {
            bookListDiv.innerHTML = ''; // Clear existing list
            books.forEach(book => {
                const div = document.createElement('div');
                div.className = 'book-item';
                div.setAttribute('data-id', book.id); // Set data-id on the div for easy lookup
                div.innerHTML = `
                    <span><i class="fas fa-book mr-2"></i>${book.name} (₹${book.price})</span>
                    <div class="quantity-control">
                        <button onclick="decrementQuantity(${book.id})"><i class="fas fa-minus"></i></button>
                        <input type="text" id="qty-${book.id}" value="0" readonly data-price="${book.price}">
                        <button onclick="incrementQuantity(${book.id})"><i class="fas fa-plus"></i></button>
                    </div>
                `;
                bookListDiv.appendChild(div);
            });
            updateTotal(); // Calculate initial total
        }

        function incrementQuantity(bookId) {
            const qtyInput = document.getElementById(`qty-${bookId}`);
            let currentQty = parseInt(qtyInput.value);
            qtyInput.value = currentQty + 1;
            updateTotal();
            toggleBookItemSelected(bookId);
        }

        function decrementQuantity(bookId) {
            const qtyInput = document.getElementById(`qty-${bookId}`);
            let currentQty = parseInt(qtyInput.value);
            if (currentQty > 0) {
                qtyInput.value = currentQty - 1;
                updateTotal();
                toggleBookItemSelected(bookId);
            }
        }

        function toggleBookItemSelected(bookId) {
            const qtyInput = document.getElementById(`qty-${bookId}`);
            const bookItemDiv = qtyInput.closest('.book-item');
            if (parseInt(qtyInput.value) > 0) {
                bookItemDiv.classList.add('selected');
            } else {
                bookItemDiv.classList.remove('selected');
            }
        }


        function updateTotal() {
            const inputs = document.querySelectorAll('#book-list input[type="text"]'); // Select the text inputs for quantity
            let total = 0;
            inputs.forEach(input => {
                const qty = parseInt(input.value) || 0;
                const price = parseInt(input.dataset.price);
                total += qty * price;
            });
            totalPriceDisplay.textContent = `Total: ₹${total}`;
        }

        /**
         * Validates the phone number format (10 digits).
         * @param {string} phoneNumber - The phone number string to validate.
         * @returns {boolean} True if the phone number is valid, false otherwise.
         */
        function validatePhoneNumber(phoneNumber) {
            const cleanedNumber = phoneNumber.replace(/\D/g, ''); // Remove all non-digits
            return cleanedNumber.length === 10;
        }

        /**
         * Displays the purchase summary modal before final submission.
         */
        function displayPurchaseSummary() {
            const firstName = document.getElementById('first-name').value.trim();
            const lastName = document.getElementById('last-name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const countryCode = document.getElementById('phone-country-code').value;
            const fullPhoneNumber = countryCode + phone;


            if (!firstName || !lastName) {
                showMessage("Please enter your first name and last name.", 'error');
                return;
            }

            if (!phone) {
                showMessage("Please enter your phone number.", 'error');
                return;
            }

            if (!validatePhoneNumber(phone)) {
                showMessage("Please enter a valid 10-digit phone number (excluding country code).", 'error');
                return;
            }

            const selectedBooks = [];
            let total = 0;

            document.querySelectorAll('#book-list input[type="text"]').forEach(input => {
                const qty = parseInt(input.value);
                if (qty > 0) {
                    const bookId = parseInt(input.closest('.book-item').dataset.id);
                    const book = books.find(b => b.id === bookId);
                    selectedBooks.push({
                        name: book.name,
                        quantity: qty,
                        price_per_item: book.price,
                        subtotal: qty * book.price
                    });
                    total += qty * book.price;
                }
            });

            if (selectedBooks.length === 0) {
                showMessage("Please select at least one book.", 'error');
                return;
            }

            let summaryHtml = `
                <div class="summary-section-item">
                    <p><strong>First Name:</strong> <span>${firstName}</span></p>
                    <p><strong>Last Name:</strong> <span>${lastName}</span></p>
                    <p><strong>Phone:</strong> <span>${fullPhoneNumber}</span></p>
                </div>
                <div class="summary-section-item">
                    <h3 class="font-bold mb-2 text-lg text-white">Order Details:</h3>
                    ${selectedBooks.map(book => `
                        <div class="summary-book-item">
                            <span>${book.name} x ${book.quantity}</span>
                            <span>₹${book.subtotal}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="summary-total">
                    Total: ₹${total}
                </div>
            `;

            summaryDetailsDiv.innerHTML = summaryHtml;
            purchaseSummaryModalOverlay.classList.add('show');
        }

        /**
         * Hides the purchase summary modal, allowing user to edit.
         */
        function editPurchase() {
            purchaseSummaryModalOverlay.classList.remove('show');
        }

        /**
         * Initiates the final confirmation prompt via a lower action bar.
         */
        function confirmPurchasePrompt() {
            // Hide the modal first
            purchaseSummaryModalOverlay.classList.remove('show');

            // Populate and show the final confirmation action bar
            finalConfirmationText.innerHTML = `Are you absolutely sure you want to confirm this booking?`;
            finalConfirmationActionBar.classList.add('show');

            // Attach event listeners to the buttons on the action bar
            finalConfirmYesBtn.onclick = confirmPurchase;
            finalConfirmNoBtn.onclick = cancelConfirmation;

            // Scroll to the bottom to make sure the sticky bar is visible
            const glassContainer = document.querySelector('.glass-container');
            if (glassContainer) {
                glassContainer.scrollTop = glassContainer.scrollHeight;
            }
        }

        /**
         * Confirms the purchase and submits data to the backend.
         */
        async function confirmPurchase() {
            // Hide the final confirmation action bar
            finalConfirmationActionBar.classList.remove('show');

            const firstName = document.getElementById('first-name').value.trim();
            const lastName = document.getElementById('last-name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const countryCode = document.getElementById('phone-country-code').value;
            const fullPhoneNumber = countryCode + phone;

            const selectedBooks = [];
            let total = 0;

            document.querySelectorAll('#book-list input[type="text"]').forEach(input => {
                const qty = parseInt(input.value);
                if (qty > 0) {
                    const bookId = parseInt(input.closest('.book-item').dataset.id);
                    const book = books.find(b => b.id === bookId);
                    selectedBooks.push({
                        name: book.name,
                        quantity: qty,
                        price_per_item: book.price
                    });
                    total += qty * book.price;
                }
            });

            const purchaseData = {
                // Combine first and last name for the 'name' field in the backend model
                name: `${firstName} ${lastName}`,
                phone: fullPhoneNumber, // Use the full phone number with country code
                books: selectedBooks,
                total_price: total,
                timestamp: new Date().toISOString() // Generate ISO string timestamp
            };

            console.log("Attempting to submit purchase:", purchaseData);

            try {
                const response = await fetch('http://127.0.0.1:8000/submit-purchase', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(purchaseData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage(`Purchase successful! 🎉 ${result.message}`, 'success');
                    console.log('Backend response:', result);
                    // Clear form after successful submission
                    document.getElementById('first-name').value = '';
                    document.getElementById('last-name').value = '';
                    document.getElementById('phone').value = '';
                    document.querySelectorAll('#book-list input[type="text"]').forEach(input => {
                        input.value = '0';
                        input.closest('.book-item').classList.remove('selected');
                    });
                    updateTotal(); // Reset total display
                } else {
                    const errorData = await response.json();
                    showMessage(`Failed to submit purchase: ${errorData.detail || response.statusText}`, 'error');
                    console.error('Backend error:', errorData);
                }
            } catch (error) {
                console.error('Network or other error during fetch:', error);
                showMessage("An error occurred while submitting. Please try again.", 'error');
            }
        }

        /**
         * Cancels the final confirmation from the chatbot and allows editing.
         */
        async function cancelConfirmation() {
            // Hide the final confirmation action bar
            finalConfirmationActionBar.classList.remove('show');
            // Optionally show a message that they can edit
            showMessage("Order cancelled. You can now make changes.", 'info');
        }

        // The renderBooks() call is now part of the window.onload sequence.
        // document.addEventListener('DOMContentLoaded', renderBooks); // Removed this
    </script>
</body>
</html>
